<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FunGroup+ - Real-Time Group Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .group-info {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 40px;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 300px;
        }

        .login-form h2 {
            color: #667eea;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-in;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        .username {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }

        .timestamp {
            font-size: 12px;
            color: #888;
        }

        .message-content {
            background: white;
            padding: 12px 15px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            max-width: 70%;
            word-wrap: break-word;
        }

        .my-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 5px 8px;
            cursor: pointer;
            border-radius: 5px;
            margin: 0 2px;
            font-size: 14px;
        }

        .action-btn:hover {
            background: #f0f0f0;
        }

        .seen-indicator {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
            text-align: right;
        }

        .deleted-message {
            font-style: italic;
            opacity: 0.6;
            color: #888;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e1e5e9;
        }

        .input-container {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 25px;
            padding: 10px 15px;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            border: none;
            background: none;
            padding: 8px;
            font-size: 16px;
            outline: none;
            resize: none;
            max-height: 100px;
        }

        .emoji-btn, .gif-btn, .send-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .emoji-btn:hover, .gif-btn:hover {
            background: #e9ecef;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 40px;
            height: 40px;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .emoji-picker, .gif-picker {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            display: none;
            z-index: 1000;
            max-width: 300px;
            max-height: 300px;
            overflow-y: auto;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }

        .emoji-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            text-align: center;
            font-size: 20px;
        }

        .emoji-item:hover {
            background: #f0f0f0;
        }

        .gif-search {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .gif-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .gif-item {
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
        }

        .gif-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .online-users {
            background: #e8f2ff;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }

        .user-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 8px;
            font-size: 12px;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: #888;
            font-size: 14px;
        }

        .edit-input {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 8px;
            margin-top: 5px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="login-form">
                <h2>🚀 Welcome to FunGroup+</h2>
                <div class="input-group">
                    <label for="username">Your Name:</label>
                    <input type="text" id="username" placeholder="Enter your name" maxlength="20">
                </div>
                <div class="input-group">
                    <label for="groupSelect">Choose Action:</label>
                    <select id="groupSelect">
                        <option value="join">Join Existing Group</option>
                        <option value="create">Create New Group</option>
                    </select>
                </div>
                <div class="input-group" id="groupNameGroup">
                    <label for="groupName">Group Name:</label>
                    <input type="text" id="groupName" placeholder="Enter group name" maxlength="30">
                </div>
                <button class="btn" onclick="joinGroup()">🎉 Let's Chat!</button>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chatScreen" style="display: none;">
            <div class="header">
                <h1>🎊 FunGroup+</h1>
                <div class="group-info">
                    <span id="currentGroup">Loading...</span> • <span id="userCount">0 users</span>
                </div>
            </div>
            
            <div class="online-users" id="onlineUsers">
                <strong>Online:</strong>
            </div>

            <div class="chat-area">
                <div class="messages" id="messages"></div>
                <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>
                
                <div class="input-area">
                    <div class="input-container">
                        <button class="emoji-btn" onclick="toggleEmojiPicker()">😊</button>
                        <button class="gif-btn" onclick="toggleGifPicker()">GIF</button>
                        <textarea class="message-input" id="messageInput" placeholder="Type your message..." rows="1"></textarea>
                        <button class="send-btn" onclick="sendMessage()">➤</button>
                    </div>
                </div>
            </div>

            <!-- Emoji Picker -->
            <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-grid" id="emojiGrid"></div>
            </div>

            <!-- GIF Picker -->
            <div class="gif-picker" id="gifPicker">
                <input type="text" class="gif-search" id="gifSearch" placeholder="Search GIFs...">
                <div class="gif-grid" id="gifGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // App State
        let socket;
        let currentUser = '';
        let currentGroup = '';
        let messages = [];
        let editingMessageId = null;
        let typingTimer;
        let onlineUsers = [];

        // Popular emojis
        const emojis = ['😀','😃','😄','😁','😊','😍','🤩','😘','😗','😚','😙','🥰','😋','😛','😜','🤪','😝','🤑','🤗','🤭','🤫','🤔','🤐','🤨','😐','😑','😶','😏','😒','🙄','😬','🤥','😌','😔','😪','🤤','😴','😷','🤒','🤕','🤢','🤮','🤧','🥵','🥶','🥴','😵','🤯','🤠','🥳','😎','🤓','🧐','😕','😟','🙁','☹️','😮','😯','😲','😳','🥺','😦','😧','😨','😰','😥','😢','😭','😱','😖','😣','😞','😓','😩','😫','🥱','😤','😡','🤬','😠','🤡','💩','👻','💀','☠️','👽','👾','🤖','🎃','😺','😸','😹','😻','😼','😽','🙀','😿','😾'];

        // Initialize emoji picker
        function initEmojiPicker() {
            const emojiGrid = document.getElementById('emojiGrid');
            emojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.onclick = () => insertEmoji(emoji);
                emojiGrid.appendChild(emojiItem);
            });
        }

        // Simulated Socket.IO for demo (replace with real Socket.IO server)
        function initSocket() {
            // Simulated socket events for demo
            const simulatedSocket = {
                users: new Map(),
                groups: new Map(),
                
                emit: function(event, data) {
                    console.log('Emitting:', event, data);
                    
                    // Simulate server responses
                    setTimeout(() => {
                        switch(event) {
                            case 'join_group':
                                this.handleJoinGroup(data);
                                break;
                            case 'send_message':
                                this.handleSendMessage(data);
                                break;
                            case 'message_seen':
                                this.handleMessageSeen(data);
                                break;
                            case 'edit_message':
                                this.handleEditMessage(data);
                                break;
                            case 'delete_message':
                                this.handleDeleteMessage(data);
                                break;
                            case 'typing':
                                this.handleTyping(data);
                                break;
                        }
                    }, 100);
                },
                
                on: function(event, callback) {
                    this[event + '_callback'] = callback;
                },
                
                handleJoinGroup: function(data) {
                    if (!this.groups.has(data.group)) {
                        this.groups.set(data.group, new Set());
                    }
                    this.groups.get(data.group).add(data.username);
                    
                    const users = Array.from(this.groups.get(data.group));
                    if (this.group_joined_callback) {
                        this.group_joined_callback({
                            success: true,
                            group: data.group,
                            users: users,
                            messages: messages.filter(m => m.group === data.group)
                        });
                    }
                    
                    if (this.user_joined_callback) {
                        this.user_joined_callback({
                            username: data.username,
                            users: users
                        });
                    }
                },
                
                handleSendMessage: function(data) {
                    const message = {
                        id: Date.now() + Math.random(),
                        username: data.username,
                        content: data.content,
                        type: data.type || 'text',
                        timestamp: new Date().toISOString(),
                        group: data.group,
                        seen_by: [data.username]
                    };
                    
                    messages.push(message);
                    
                    if (this.new_message_callback) {
                        this.new_message_callback(message);
                    }
                },
                
                handleMessageSeen: function(data) {
                    const message = messages.find(m => m.id == data.messageId);
                    if (message && !message.seen_by.includes(data.username)) {
                        message.seen_by.push(data.username);
                        if (this.message_seen_callback) {
                            this.message_seen_callback({
                                messageId: data.messageId,
                                seenBy: message.seen_by
                            });
                        }
                    }
                },
                
                handleEditMessage: function(data) {
                    const message = messages.find(m => m.id == data.messageId);
                    if (message && message.username === data.username) {
                        message.content = data.newContent;
                        message.edited = true;
                        if (this.message_edited_callback) {
                            this.message_edited_callback({
                                messageId: data.messageId,
                                newContent: data.newContent
                            });
                        }
                    }
                },
                
                handleDeleteMessage: function(data) {
                    const message = messages.find(m => m.id == data.messageId);
                    if (message && message.username === data.username) {
                        message.deleted = true;
                        if (this.message_deleted_callback) {
                            this.message_deleted_callback({
                                messageId: data.messageId
                            });
                        }
                    }
                },
                
                handleTyping: function(data) {
                    if (this.user_typing_callback) {
                        this.user_typing_callback(data);
                    }
                }
            };
            
            return simulatedSocket;
        }

        // Initialize app
        function init() {
            socket = initSocket();
            initEmojiPicker();
            setupEventListeners();
            
            // Check notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function setupEventListeners() {
            // Socket events
            socket.on('group_joined', (data) => {
                if (data.success) {
                    currentGroup = data.group;
                    onlineUsers = data.users;
                    updateUI();
                    loadMessages(data.messages || []);
                    updateOnlineUsers();
                }
            });

            socket.on('user_joined', (data) => {
                onlineUsers = data.users;
                updateOnlineUsers();
                showNotification(`${data.username} joined the group`, 'info');
            });

            socket.on('new_message', (message) => {
                displayMessage(message);
                
                // Show notification if tab not focused
                if (document.hidden && message.username !== currentUser) {
                    showDesktopNotification(`${message.username}`, message.content);
                    playNotificationSound();
                }
                
                // Auto-mark as seen after 2 seconds
                setTimeout(() => {
                    if (isMessageVisible(message.id)) {
                        markMessageAsSeen(message.id);
                    }
                }, 2000);
            });

            socket.on('message_seen', (data) => {
                updateSeenIndicator(data.messageId, data.seenBy);
            });

            socket.on('message_edited', (data) => {
                updateEditedMessage(data.messageId, data.newContent);
            });

            socket.on('message_deleted', (data) => {
                updateDeletedMessage(data.messageId);
            });

            socket.on('user_typing', (data) => {
                showTypingIndicator(data.username);
            });

            // Input events
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                } else {
                    handleTyping();
                }
            });

            messageInput.addEventListener('input', (e) => {
                autoResize(e.target);
            });

            // GIF search
            const gifSearch = document.getElementById('gifSearch');
            gifSearch.addEventListener('input', debounce(searchGifs, 500));

            // Close pickers when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.emoji-picker') && !e.target.closest('.emoji-btn')) {
                    document.getElementById('emojiPicker').style.display = 'none';
                }
                if (!e.target.closest('.gif-picker') && !e.target.closest('.gif-btn')) {
                    document.getElementById('gifPicker').style.display = 'none';
                }
            });
        }

        function joinGroup() {
            const username = document.getElementById('username').value.trim();
            const groupName = document.getElementById('groupName').value.trim();
            
            if (!username) {
                alert('Please enter your name');
                return;
            }
            
            if (!groupName) {
                alert('Please enter a group name');
                return;
            }
            
            currentUser = username;
            currentGroup = groupName;
            
            // Hide login screen and show chat
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            
            // Join group via socket
            socket.emit('join_group', {
                username: currentUser,
                group: currentGroup
            });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            if (editingMessageId) {
                // Edit existing message
                socket.emit('edit_message', {
                    messageId: editingMessageId,
                    newContent: content,
                    username: currentUser
                });
                cancelEdit();
            } else {
                // Send new message
                socket.emit('send_message', {
                    username: currentUser,
                    content: content,
                    group: currentGroup,
                    type: 'text'
                });
            }
            
            input.value = '';
            autoResize(input);
        }

        function displayMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.username === currentUser ? 'my-message' : ''}`;
            messageDiv.dataset.messageId = message.id;
            
            const isOwner = message.username === currentUser;
            const actionsHtml = isOwner ? `
                <div class="message-actions">
                    <button class="action-btn" onclick="editMessage('${message.id}')" title="Edit">✏️</button>
                    <button class="action-btn" onclick="deleteMessage('${message.id}')" title="Delete">🗑️</button>
                </div>
            ` : '';
            
            const avatar = message.username.charAt(0).toUpperCase();
            const timestamp = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let contentHtml = '';
            if (message.deleted) {
                contentHtml = '<span class="deleted-message">This message was deleted</span>';
            } else if (message.type === 'gif') {
                contentHtml = `<img src="${message.content}" alt="GIF" style="max-width: 200px; border-radius: 8px;">`;
            } else {
                contentHtml = escapeHtml(message.content);
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="avatar">${avatar}</div>
                    <span class="username">${escapeHtml(message.username)}</span>
                    <span class="timestamp">${timestamp}</span>
                    ${message.edited ? '<span class="timestamp">(edited)</span>' : ''}
                </div>
                <div class="message-content">
                    ${contentHtml}
                </div>
                ${actionsHtml}
                ${isOwner ? `<div class="seen-indicator" id="seen-${message.id}">✅</div>` : ''}
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Update seen indicator if we have data
            if (message.seen_by && message.seen_by.length > 1) {
                updateSeenIndicator(message.id, message.seen_by);
            }
        }

        function loadMessages(messageList) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            messageList.forEach(message => displayMessage(message));
        }

        function updateUI() {
            document.getElementById('currentGroup').textContent = currentGroup;
        }

        function updateOnlineUsers() {
            const onlineUsersDiv = document.getElementById('onlineUsers');
            const userTags = onlineUsers.map(user => 
                `<span class="user-tag">${escapeHtml(user)}</span>`
            ).join('');
            onlineUsersDiv.innerHTML = `<strong>Online (${onlineUsers.length}):</strong> ${userTags}`;
            document.getElementById('userCount').textContent = `${onlineUsers.length} users`;
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            const gifPicker = document.getElementById('gifPicker');
            gifPicker.style.display = 'none';
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        }

        function toggleGifPicker() {
            const picker = document.getElementById('gifPicker');
            const emojiPicker = document.getElementById('emojiPicker');
            emojiPicker.style.display = 'none';
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
            
            if (picker.style.display === 'block') {
                searchGifs('funny'); // Default search
            }
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            document.getElementById('emojiPicker').style.display = 'none';
        }

        async function searchGifs(query) {
            if (!query) return;
            
            // Simulated GIF results (in real app, use Giphy API)
            const gifs = [
                'https://media.giphy.com/media/3o7aCSPqXE5C6T8tBC/giphy.gif',
                'https://media.giphy.com/media/l0HlvtIPzPdt2usKs/giphy.gif',
                'https://media.giphy.com/media/3o6Zt4HU9uwXmXSAuI/giphy.gif',
                'https://media.giphy.com/media/l46CyJmS9KUbokzsI/giphy.gif',
            ];
            
            const gifGrid = document.getElementById('gifGrid');
            gifGrid.innerHTML = '';
            
            gifs.forEach(gifUrl => {
                const gifItem = document.createElement('div');
                gifItem.className = 'gif-item';
                gifItem.innerHTML = `<img src="${gifUrl}" alt="GIF">`;
                gifItem.onclick = () => sendGif(gifUrl);
                gifGrid.appendChild(gifItem);
            });
        }

        function sendGif(gifUrl) {
            socket.emit('send_message', {
                username: currentUser,
                content: gifUrl,
                group: currentGroup,
                type: 'gif'
            });
            
            document.getElementById('gifPicker').style.display = 'none';
        }

        function editMessage(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            const contentDiv = messageDiv.querySelector('.message-content');
            const currentContent = contentDiv.textContent;
            
            editingMessageId = messageId;
            const input = document.getElementById('messageInput');
            input.value = currentContent;
            input.focus();
            input.style.background = '#fff3cd';
            input.placeholder = 'Editing message... Press Enter to save, Esc to cancel';
            
            // Add escape key handler
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    cancelEdit();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        function cancelEdit() {
            editingMessageId = null;
            const input = document.getElementById('messageInput');
            input.value = '';
            input.style.background = '';
            input.placeholder = 'Type your message...';
        }

        function deleteMessage(messageId) {
            if (confirm('Are you sure you want to delete this message?')) {
                socket.emit('delete_message', {
                    messageId: messageId,
                    username: currentUser
                });
            }
        }

        function markMessageAsSeen(messageId) {
            socket.emit('message_seen', {
                messageId: messageId,
                username: currentUser
            });
        }

        function updateSeenIndicator(messageId, seenBy) {
            const indicator = document.getElementById(`seen-${messageId}`);
            if (indicator && seenBy.length > 1) {
                const otherUsers = seenBy.filter(user => user !== currentUser);
                if (otherUsers.length > 0) {
                    indicator.innerHTML = `👁️ Seen by: ${otherUsers.join(', ')}`;
                }
            }
        }

        function updateEditedMessage(messageId, newContent) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                const contentDiv = messageDiv.querySelector('.message-content');
                contentDiv.innerHTML = escapeHtml(newContent);
                
                // Add edited indicator
                let editedSpan = messageDiv.querySelector('.timestamp:last-child');
                if (!editedSpan || !editedSpan.textContent.includes('edited')) {
                    const headerDiv = messageDiv.querySelector('.message-header');
                    const editedIndicator = document.createElement('span');
                    editedIndicator.className = 'timestamp';
                    editedIndicator.textContent = '(edited)';
                    headerDiv.appendChild(editedIndicator);
                }
            }
        }

        function updateDeletedMessage(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                const contentDiv = messageDiv.querySelector('.message-content');
                contentDiv.innerHTML = '<span class="deleted-message">This message was deleted</span>';
                
                // Remove action buttons
                const actions = messageDiv.querySelector('.message-actions');
                if (actions) actions.remove();
            }
        }

        function handleTyping() {
            clearTimeout(typingTimer);
            
            socket.emit('typing', {
                username: currentUser,
                group: currentGroup,
                isTyping: true
            });
            
            typingTimer = setTimeout(() => {
                socket.emit('typing', {
                    username: currentUser,
                    group: currentGroup,
                    isTyping: false
                });
            }, 1000);
        }

        function showTypingIndicator(username) {
            if (username === currentUser) return;
            
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = `${username} is typing...`;
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.textContent = message;
            
            if (type === 'error') {
                toast.style.background = '#dc3545';
            } else if (type === 'success') {
                toast.style.background = '#28a745';
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showDesktopNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`New message in ${currentGroup}`, {
                    body: `${title}: ${body}`,
                    icon: '🎊',
                    tag: 'fungroup-message'
                });
            }
        }

        function playNotificationSound() {
            try {
                // Create audio context for notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio notification not supported');
            }
        }

        function isMessageVisible(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return false;
            
            const messagesContainer = document.getElementById('messages');
            const rect = messageDiv.getBoundingClientRect();
            const containerRect = messagesContainer.getBoundingClientRect();
            
            return rect.top >= containerRect.top && rect.bottom <= containerRect.bottom;
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Handle visibility change for notifications
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Mark visible messages as seen when tab becomes active
                const visibleMessages = document.querySelectorAll('.message:not(.my-message)');
                visibleMessages.forEach(messageDiv => {
                    const messageId = messageDiv.dataset.messageId;
                    if (isMessageVisible(messageId)) {
                        markMessageAsSeen(messageId);
                    }
                });
            }
        });

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);

        // Service Worker for better offline experience (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    console.log('Service Worker registration failed');
                });
            });
        }

        // Add some demo messages for testing
        function addDemoMessages() {
            const demoMessages = [
                {
                    id: 1,
                    username: 'Alice',
                    content: 'Hey everyone! 👋 Welcome to FunGroup+',
                    type: 'text',
                    timestamp: new Date(Date.now() - 300000).toISOString(),
                    group: currentGroup,
                    seen_by: ['Alice', currentUser]
                },
                {
                    id: 2,
                    username: 'Bob',
                    content: 'This looks amazing! Love the real-time features 🚀',
                    type: 'text',
                    timestamp: new Date(Date.now() - 240000).toISOString(),
                    group: currentGroup,
                    seen_by: ['Bob']
                },
                {
                    id: 3,
                    username: 'Charlie',
                    content: 'https://media.giphy.com/media/3o7aCSPqXE5C6T8tBC/giphy.gif',
                    type: 'gif',
                    timestamp: new Date(Date.now() - 180000).toISOString(),
                    group: currentGroup,
                    seen_by: ['Charlie']
                }
            ];
            
            setTimeout(() => {
                demoMessages.forEach(msg => displayMessage(msg));
            }, 1000);
        }

        // Enhanced group selection
        document.getElementById('groupSelect').addEventListener('change', function() {
            const groupNameInput = document.getElementById('groupName');
            if (this.value === 'create') {
                groupNameInput.placeholder = 'Create new group name';
            } else {
                groupNameInput.placeholder = 'Enter existing group name';
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter to send message
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                sendMessage();
            }
            
            // Alt + E to toggle emoji picker
            if (e.altKey && e.key === 'e') {
                e.preventDefault();
                toggleEmojiPicker();
            }
            
            // Alt + G to toggle GIF picker
            if (e.altKey && e.key === 'g') {
                e.preventDefault();
                toggleGifPicker();
            }
        });

        // Add message reactions (future feature)
        function addReaction(messageId, emoji) {
            socket.emit('add_reaction', {
                messageId: messageId,
                emoji: emoji,
                username: currentUser
            });
        }

        // Add @mention functionality
        function checkForMentions(content) {
            const mentions = content.match(/@(\w+)/g);
            if (mentions) {
                mentions.forEach(mention => {
                    const username = mention.substring(1);
                    if (onlineUsers.includes(username)) {
                        showNotification(`You mentioned ${username}`, 'info');
                    }
                });
            }
        }

        // Enhanced message formatting
        function formatMessage(content) {
            // Bold text: *text*
            content = content.replace(/\*([^*]+)\*/g, '<strong>$1</strong>');
            
            // Italic text: _text_
            content = content.replace(/_([^_]+)_/g, '<em>$1</em>');
            
            // Code: `code`
            content = content.replace(/`([^`]+)`/g, '<code style="background:#f1f3f4;padding:2px 4px;border-radius:3px;">$1</code>');
            
            // Links
            content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#667eea;">$1</a>');
            
            return content;
        }

        // Add dark mode toggle (bonus feature)
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
    </script>

    <style>
        /* Dark mode styles */
        .dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
        }

        .dark-mode .container {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .dark-mode .messages {
            background: var(--bg-secondary);
        }

        .dark-mode .message-content {
            background: #3a3a3a;
            color: var(--text-primary);
        }

        .dark-mode .my-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .dark-mode .input-container {
            background: #3a3a3a;
        }

        .dark-mode .message-input {
            color: var(--text-primary);
        }

        .dark-mode .emoji-picker,
        .dark-mode .gif-picker {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .dark-mode .online-users {
            background: #2a2a2a;
            color: var(--text-primary);
        }

        /* Responsive improvements */
        @media (max-width: 480px) {
            .login-form {
                padding: 20px;
                margin: 20px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .input-area {
                padding: 15px;
            }
            
            .message-content {
                max-width: 90%;
            }
            
            .emoji-picker,
            .gif-picker {
                width: 90%;
                right: 5%;
            }
        }

        /* Animation improvements */
        .message {
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .user-tag {
            animation: fadeIn 0.5s ease-in;
        }

        /* Hover effects */
        .message:hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Accessibility improvements */
        .btn:focus,
        .action-btn:focus,
        .emoji-btn:focus,
        .gif-btn:focus,
        .send-btn:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* Custom scrollbar */
        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
    </style>
</body>
</html>
